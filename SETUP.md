# Course Selection System - Setup Guide

This guide will help you set up and run the Course Selection System.

## Prerequisites

- Python 3.10 or higher
- Node.js 16 or higher
- npm or yarn

## Backend Setup

### 1. Install Python dependencies

Using pip:
```bash
pip install -e .
```

Or using uv (recommended):
```bash
pip install uv
uv sync
```

### 2. Configure environment variables

Each backend service needs a `.env` file. Copy the example files:

```bash
cd backend/data_node && cp .env.example .env
cd ../auth_node && cp .env.example .env
cd ../teacher_node && cp .env.example .env
cd ../student_node && cp .env.example .env
cd ../queue_node && cp .env.example .env
cd ../..
```

**Important:** Update the following values in all applicable `.env` files:

1. **INTERNAL_TOKEN** - Must be the same in all services for inter-service communication:
```env
INTERNAL_TOKEN=your-secure-random-token-here-change-this
```

2. **JWT_SECRET_KEY** - Must be the same in auth_node, student_node, and teacher_node for JWT token validation:
```env
JWT_SECRET_KEY=your-secure-jwt-secret-key-here-change-this
```

**⚠️ CRITICAL:** If `JWT_SECRET_KEY` is not set or differs between services, students and teachers will get 401 Unauthorized errors after login!

You can generate secure random values with:
```bash
python -c "import secrets; print(secrets.token_urlsafe(32))"
```

### 3. Start backend services

You can start all services with the provided script:

```bash
./start_backend.sh
```

Or start them individually:

```bash
# Terminal 1 - Data Node
python -m backend.data_node.main

# Terminal 2 - Auth Node
python -m backend.auth_node.main

# Terminal 3 - Teacher Node
python -m backend.teacher_node.main

# Terminal 4 - Student Node
python -m backend.student_node.main

# Terminal 5 - Queue Node
python -m backend.queue_node.main
```

Services will be available at:
- Data Node: http://localhost:8001
- Auth Node: http://localhost:8002
- Teacher Node: http://localhost:8003
- Student Node: http://localhost:8004
- Queue Node: http://localhost:8005

## Frontend Setup

### 1. Install dependencies

```bash
cd frontend
npm install
```

### 2. Start development server

```bash
npm run dev
```

The frontend will be available at http://localhost:3000

## Initial Setup

### 1. Create an admin account

The system creates a default admin account on first run:
- Username: `admin`
- Password: `admin123`

**Important:** Change this password in production!

### 2. Login as admin

1. Go to http://localhost:3000
2. Click on the "Admin Login" tab
3. Use the credentials above

### 3. Generate registration codes

1. Navigate to "Registration Codes" in the admin panel
2. Generate codes for students and teachers
3. Share these codes with users for registration

### 4. Register users

Students and teachers can register at http://localhost:3000/register using:
- Username
- Password
- User type (Student/Teacher)
- Registration code (generated by admin)

### 5. Setup 2FA

After registration:
1. Scan the QR code with an authenticator app (Google Authenticator, Authy, etc.)
2. Save the secret key in a secure location
3. Enter the 6-digit code to complete setup

## Testing the System

### Run backend tests

```bash
pytest tests/ -v
```

### Test the workflow

1. **As Admin:**
   - Login and generate registration codes
   - Create initial teacher and student accounts

2. **As Teacher:**
   - Login with 2FA
   - Create courses with details (name, credits, type, capacity, etc.)
   - View and manage your courses

3. **As Student:**
   - Login with 2FA
   - Browse available courses
   - Select courses (requests go to queue)
   - View selected courses and schedule
   - Drop courses if needed

## API Documentation

Each service provides interactive API documentation (Swagger UI):

- Data Node: http://localhost:8001/docs
- Auth Node: http://localhost:8002/docs
- Teacher Node: http://localhost:8003/docs
- Student Node: http://localhost:8004/docs
- Queue Node: http://localhost:8005/docs

## Key Features

### 1. Two-Factor Authentication (2FA)
- Students must use 2FA for login and token refresh
- Teachers and admins don't require 2FA
- QR code generation for easy setup

### 2. Rate Limiting
- Token bucket algorithm implementation
- Dual rate limiting: frontend token pool + backend IP-based limiting
- Support for X-Forwarded-For header
- Configurable limits per service

### 3. Queue System
- Course selection/deselection goes through a queue
- Prevents database overload during peak times
- Priority system (deselection has higher priority)
- Real-time status tracking

### 4. Role-Based Access Control
- Students: Can browse and select courses
- Teachers: Can create, modify, delete courses
- Admins: Can manage users and generate codes

### 5. Token Management
- Refresh token + Access token mechanism
- Refresh tokens valid for 7 days
- Access tokens valid for 30 minutes
- Secure token storage and revocation

## Troubleshooting

### 401 Unauthorized errors for students/teachers after login

**Symptom:** `/api/auth/get/user` works but `/api/student/courses/available` or `/api/teacher/courses` returns 401 with "Invalid authentication credentials"

**Cause:** JWT_SECRET_KEY is not configured or differs between services

**Solution:** 
1. Ensure JWT_SECRET_KEY is set in `.env` files for auth_node, student_node, and teacher_node
2. The JWT_SECRET_KEY value must be **exactly the same** in all three services
3. Restart all backend services after updating the .env files

Generate a secure key:
```bash
python -c "import secrets; print(secrets.token_urlsafe(32))"
```

Then add it to each .env file:
```env
JWT_SECRET_KEY=your-generated-key-here
```

### Backend services won't start
- Check if ports 8001-8005 are available
- Verify Python dependencies are installed
- Check `.env` files are configured correctly

### Frontend can't connect to backend
- Verify all backend services are running
- Check the proxy configuration in `frontend/vite.config.js`
- Ensure CORS is enabled in backend services

### 2FA not working
- Verify your device time is synchronized
- Check the TOTP secret is correct
- Try using a different authenticator app

### Rate limiting issues
- Rate limiters reset over time
- Check your IP address isn't being blocked
- Verify X-Forwarded-For headers if behind a proxy

## Production Deployment

For production deployment:

1. Change all default passwords and tokens
2. Use environment variables for sensitive data
3. Enable HTTPS for all services
4. Configure proper CORS origins
5. Use a production-grade database (PostgreSQL)
6. Set up proper logging and monitoring
7. Implement backup and disaster recovery
8. Use a reverse proxy (nginx) for load balancing

## License

MIT
